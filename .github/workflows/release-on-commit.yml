name: Release on Commit

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]' && github.actor != 'dependabot[bot]'

    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: æ‰“å° github.actor
        run: |
          echo "ACTOR=${{ github.actor }}" >> $GITHUB_ENV
          echo "Triggered by: $ACTOR"

      - name: å®‰è£…node
        uses: actions/setup-node@v4
        with:
          node-version: 21
          registry-url: "https://registry.npmjs.org"

      - name: å®‰è£…pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9.7.1

      - name: å®‰è£…ä¾èµ–
        run: |
          pnpm install
          pnpm add node-karin@latest

      - name: æ”¾å¼ƒ package.json çš„æœ¬åœ°æ›´æ”¹
        run: |
          git checkout HEAD package.json

      - name: åˆ é™¤ pnpm-lock.yaml
        run: rm -rf pnpm-lock.yaml

      - name: ç¼–è¯‘
        run: pnpm build

      - name: è·å–å½“å‰æäº¤å“ˆå¸Œ
        run: echo "COMMIT_HASH=${{ github.sha }}" >> $GITHUB_ENV
        id: get_commit_hash

      - name: è®¾ç½®å½“å‰åˆ†æ”¯åç§°åˆ°ç¯å¢ƒå˜é‡
        run: |
          BRANCH_NAME=$(echo ${{ github.ref }} | sed 's|refs/heads/||')
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          echo "Current branch: $BRANCH_NAME"

      - name: è·å–çŸ­å“ˆå¸Œå€¼
        run: echo "SHORT_COMMIT_HASH=$(echo ${{ env.COMMIT_HASH }} | cut -c1-7)" >> $GITHUB_ENV

      - name: åˆ›å»ºä¸´æ—¶æ–‡ä»¶å¤¹å­˜å‚¨ç¼–è¯‘åçš„libæ–‡ä»¶å¤¹å’Œresourcesæ–‡ä»¶å¤¹
        run: |
          mkdir ./../temp

      - name: å¤åˆ¶ç¼–è¯‘åçš„libæ–‡ä»¶å¤¹å’Œresourcesæ–‡ä»¶å¤¹åˆ°ä¸´æ—¶æ–‡ä»¶å¤¹
        run: |
          cp -r ./lib ./../temp/lib
          cp -r ./resources ./../temp/resources

      - name: æ£€æŸ¥å¹¶åˆ›å»ºç©ºçš„ dev åˆ†æ”¯
        run: |
          git fetch origin
          # æ£€æŸ¥ dev åˆ†æ”¯æ˜¯å¦å­˜åœ¨
          if git show-ref --verify --quiet refs/heads/dev; then
            echo "Dev branch exists locally. Switching to it."
            git checkout dev
          else
            # æ£€æŸ¥è¿œç¨‹æ˜¯å¦æœ‰ dev åˆ†æ”¯
            if git ls-remote --exit-code --heads origin dev; then
              echo "Dev branch exists remotely. Fetching and switching to it."
              git checkout dev
            else
              # dev åˆ†æ”¯ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªç©ºçš„ dev åˆ†æ”¯
              echo "Dev branch does not exist. Creating an empty dev branch."
              git checkout --orphan dev  # åˆ›å»ºä¸€ä¸ªæ²¡æœ‰å†å²è®°å½•çš„ç©ºåˆ†æ”¯
              git reset --hard  # é‡ç½®æ‰€æœ‰æ–‡ä»¶
              git clean -fdx  # åˆ é™¤æœªè¢« Git ç®¡ç†çš„æ–‡ä»¶å’Œæ–‡ä»¶å¤¹
              echo "Empty dev branch created."
              git commit --allow-empty -m "Initial empty commit on dev branch"
              git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} dev  # æ¨é€åˆ°è¿œç¨‹ä»“åº“
            fi
          fi

      - name: åˆ‡æ¢åˆ° build åˆ†æ”¯
        run: |
          git fetch origin dev
          git checkout dev

      - name: åˆ é™¤devåˆ†æ”¯ä¸Šçš„libæ–‡ä»¶å¤¹å’Œresourcesæ–‡ä»¶å¤¹
        run: |
          rm -rf lib
          rm -rf resources

      - name: å¤åˆ¶ç¼–è¯‘åçš„libæ–‡ä»¶å¤¹å’Œresourcesæ–‡ä»¶å¤¹åˆ° dev åˆ†æ”¯
        run: |
          cp -r ./../temp/lib ./
          cp -r ./../temp/resources ./

      - name: åˆ é™¤ä¸´æ—¶æ–‡ä»¶å¤¹
        run: |
          rm -rf ./../temp

      - name: ä»mainåˆ†æ”¯å¤åˆ¶æ–‡ä»¶åˆ°devåˆ†æ”¯
        run: |
          git checkout main -- package.json CHANGELOG.md README.md config resources LICENSE

      - name: ä¿®è®¢ç‰ˆæœ¬å·
        run: npm run commit all
        if: success()

      - name: åˆ é™¤ä¾èµ–æ–‡ä»¶å¤¹ node_modules
        run: |
          rm -rf node_modules

      - name: å°†æ–‡ä»¶æ•´ç†åˆ° karin-plugin-ling æ–‡ä»¶å¤¹
        run: |
          mkdir -p karin-plugin-ling
          find . -path "./.git" -prune -o -type f -print | while read file; do
            mkdir -p "karin-plugin-ling/$(dirname "$file")"
            cp "$file" "karin-plugin-ling/$file"
          done

      - name: åˆ›å»º dev.zip
        run: zip -r "dev-${{ env.SHORT_COMMIT_HASH }}.zip" karin-plugin-ling

      - name: ä¸Šä¼  dev.zip
        uses: actions/upload-artifact@v4
        with:
          name: "dev-${{ env.SHORT_COMMIT_HASH }}.zip"
          path: "dev-${{ env.SHORT_COMMIT_HASH }}.zip"

      - name: åˆ é™¤ karin-plugin-ling æ–‡ä»¶å¤¹
        run: rm -rf karin-plugin-ling

      - name: å‘å¸ƒåˆ° npm
        run: npm run pub-beta
        if: success()
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}


      - name: åˆ›å»ºå‘è¡Œç‰ˆ
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: "${{ env.PKG_VERSION }}"
          release_name: "${{ env.PKG_VERSION }}"
          body: |
            ### ğŸ‰ æ„å»ºå®Œæˆï¼
            - æ­¤ç‰ˆæœ¬æ˜¯åŸºäºå¿«ç…§ [`${{ env.SHORT_COMMIT_HASH }}`](https://github.com/${{ github.repository }}/tree/${{ env.COMMIT_HASH }}) æ‰€æ„å»ºçš„ï¼Œ[**ç‚¹å‡»æ­¤å¤„æŸ¥çœ‹æ›´æ”¹**](https://github.com/${{ github.repository }}/commit/${{ env.COMMIT_HASH }}) By @${{ github.actor }}

            ### å®‰è£…è¯¥ç‰ˆæœ¬
            **ä»¥ä¸‹å®‰è£…æ–¹å¼ä»»é€‰å…¶ä¸€**
            ---
            <details>
            <summary>ä½¿ç”¨Git</summary>
            
            **æ’ä»¶æ ¹ç›®å½•** ä¸‹æ‰§è¡Œ
            ```sh
            git pull
            ```
            ```sh
            git checkout ${{ env.COMMIT_HASH }}
            ```

            è‹¥æŠ¥é”™ç¼ºå¤±ä¾èµ–ï¼Œå¯å…ˆè¿è¡Œ `pnpm install` å®‰è£…æˆ–æ›´æ–°ä¾èµ–ã€‚

            </details>
           

            <details>
            <summary>ä½¿ç”¨åŒ…ç®¡ç†å™¨</summary>
          
            **Karin æ ¹ç›®å½•** ä¸‹æ‰§è¡Œ

            ```sh
            pnpm add karin-plugin-ling@${{ env.PKG_VERSION }} -w
            ```

            </details>
           

            <details>
            <summary>ä½¿ç”¨é¢„å‘è¡Œç‰ˆï¼ˆä¸æ¨èï¼‰</summary>

            1. ä¸‹è½½åä¸º [build-${{ env.SHORT_COMMIT_HASH }}.zip](https://github.com/${{ github.repository }}/releases/download/pre-${{ env.SHORT_COMMIT_HASH }}/build-${{ env.SHORT_COMMIT_HASH }}.zip) çš„å‹ç¼©åŒ…
            2. åœ¨ `karin/plugins/` ç›®å½•ä¸‹è§£å‹è¯¥å‹ç¼©åŒ…ï¼Œé€‰æ‹©æ›¿æ¢æ‰€æœ‰æ–‡ä»¶ã€‚
            3. å®Œæˆåç›¸å…³æºç åº”åœ¨ `Karinæ ¹ç›®å½•/plugins/karin-plugin-kkk/` å†…<br><br>
          
            è‹¥æŠ¥é”™ç¼ºå¤±ä¾èµ–ï¼Œå¯å…ˆè¿è¡Œ `pnpm install` å®‰è£…æˆ–æ›´æ–°ä¾èµ–ã€‚
          
            </details>
            
            ---
            **æ­¤ç‰ˆæœ¬éæ­£å¼ç‰ˆæœ¬ï¼Œå¯èƒ½å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œè¯·è°¨æ…ä½¿ç”¨ï¼**
            æ„å»ºæ—¶é—´ï¼š${{ github.event.head_commit.timestamp }}
          draft: false
          prerelease: true

      - name: ä¸Šä¼ 
        id: upload-release-asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: "./build-${{ env.SHORT_COMMIT_HASH }}.zip"
          asset_name: "build-${{ env.SHORT_COMMIT_HASH }}.zip"
          asset_content_type: application/zip